{% extends "base.html" %}
{% block title %}Paramètres - Easy Facture{% endblock %}
{% block content %}
<h1><i class="bi bi-gear"></i> Paramètres de l'entreprise</h1>

<div class="card">
    <div class="card-body">
        <form method="POST" action="{{ url_for('parametres.save') }}" enctype="multipart/form-data">
            <div class="mb-3">
                <label class="form-label">Logo de l'entreprise</label>
                {% if entreprise.logo_path %}
                <div class="mb-2">
                    <img src="{{ url_for('uploaded_file', filename='logos/' + entreprise.logo_path.split('/')[-1]) }}" 
                         alt="Logo" 
                         style="max-height: 100px; border: 1px solid #ddd; padding: 5px; border-radius: 4px;">
                    <a href="{{ url_for('parametres.delete_logo') }}" 
                       class="btn btn-sm btn-danger ms-2"
                       onclick="return confirm('Supprimer le logo ?')">
                        <i class="bi bi-trash"></i> Supprimer
                    </a>
                </div>
                {% endif %}
                <input type="file" 
                       name="logo" 
                       class="form-control" 
                       accept="image/png,image/jpeg,image/jpg,image/gif">
                <small class="text-muted">Formats acceptés : PNG, JPG, GIF - Max 5 Mo</small>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nom de l'entreprise *</label>
                    <input type="text" name="nom" class="form-control" value="{{ entreprise.nom }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">SIRET</label>
                    <input type="text" name="siret" class="form-control" value="{{ entreprise.siret or '' }}">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-control" value="{{ entreprise.email or '' }}">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Téléphone</label>
                    <input type="text" name="telephone" class="form-control" value="{{ entreprise.telephone or '' }}">
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Adresse</label>
                <textarea name="adresse" class="form-control" rows="2">{{ entreprise.adresse or '' }}</textarea>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Code postal</label>
                    <input type="text" name="code_postal" class="form-control" value="{{ entreprise.code_postal or '' }}">
                </div>
                <div class="col-md-8 mb-3">
                    <label class="form-label">Ville</label>
                    <input type="text" name="ville" class="form-control" value="{{ entreprise.ville or '' }}">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">TVA Intracommunautaire</label>
                    <input type="text" name="tva_intra" class="form-control" value="{{ entreprise.tva_intra or '' }}">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Taux TVA par défaut (%)</label>
                    <input type="number" name="taux_tva_defaut" class="form-control" step="0.01" 
                           value="{{ entreprise.taux_tva_defaut }}" required>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Site web</label>
                <input type="url" name="site_web" class="form-control" value="{{ entreprise.site_web or '' }}">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Mentions légales</label>
                <textarea name="mentions_legales" class="form-control" rows="3">{{ entreprise.mentions_legales or '' }}</textarea>
            </div>

            <!-- Section Configuration Email (SMTP) -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-envelope-at"></i> Configuration Email (SMTP)</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Configurez votre serveur SMTP pour envoyer des factures et devis par email.
                    </p>
                    
                    <!-- Serveur SMTP -->
                    <div class="mb-3">
                        <label for="smtp_server" class="form-label">Serveur SMTP *</label>
                        <input type="text" 
                            class="form-control" 
                            id="smtp_server" 
                            name="smtp_server"
                            value="{{ entreprise.smtp_server or '' }}"
                            placeholder="smtp.gmail.com ou smtp-mail.outlook.com">
                        <small class="text-muted">
                            Gmail: smtp.gmail.com | Outlook: smtp-mail.outlook.com | Custom: votre.serveur.com
                        </small>
                    </div>
                    
                    <div class="row">
                        <!-- Port SMTP -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtp_port" class="form-label">Port SMTP</label>
                                <input type="number" 
                                    class="form-control" 
                                    id="smtp_port" 
                                    name="smtp_port"
                                    value="{{ entreprise.smtp_port or 587 }}"
                                    placeholder="587">
                                <small class="text-muted">Par défaut: 587 (TLS) ou 465 (SSL)</small>
                            </div>
                        </div>
                        
                        <!-- TLS -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sécurité</label>
                                <div class="form-check">
                                    <input class="form-check-input" 
                                        type="checkbox" 
                                        id="smtp_use_tls" 
                                        name="smtp_use_tls"
                                        {% if entreprise.smtp_use_tls is none or entreprise.smtp_use_tls %}checked{% endif %}>
                                    <label class="form-check-label" for="smtp_use_tls">
                                        Utiliser TLS/STARTTLS
                                    </label>
                                </div>
                                <small class="text-muted">Recommandé pour Gmail et Outlook</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Email utilisateur -->
                    <div class="mb-3">
                        <label for="smtp_user" class="form-label">Email expéditeur *</label>
                        <input type="email" 
                            class="form-control" 
                            id="smtp_user" 
                            name="smtp_user"
                            value="{{ entreprise.smtp_user or '' }}"
                            placeholder="votre-email@example.com">
                        <small class="text-muted">
                            L'adresse email qui apparaîtra comme expéditeur
                        </small>
                    </div>
                    
                    <!-- Mot de passe -->
                    <div class="mb-3">
                        <label for="smtp_password" class="form-label">
                            Mot de passe / App Password *
                        </label>
                        <input type="password" 
                            class="form-control" 
                            id="smtp_password" 
                            name="smtp_password"
                            placeholder="Laissez vide pour ne pas changer">
                        <small class="text-muted">
                            <strong>Gmail:</strong> Utilisez un "Mot de passe d'application" (pas votre mot de passe Gmail principal)
                            <a href="https://myaccount.google.com/apppasswords" target="_blank">Créer ici</a><br>
                            <strong>Outlook:</strong> Utilisez votre mot de passe Outlook habituel
                        </small>
                    </div>
                    
                    <!-- Alerte importante -->
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Important :</strong>
                        <ul class="mb-0">
                            <li><strong>Gmail :</strong> Activez "Validation en deux étapes" puis créez un "Mot de passe d'application"</li>
                            <li><strong>Outlook :</strong> Utilisez directement votre mot de passe</li>
                            <li><strong>Autre :</strong> Consultez la documentation de votre fournisseur email</li>
                        </ul>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Sauvegarder
            </button>
        </form>
    </div>
</div>

<!-- Section Licence -->
<div class="card mt-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-key"></i> Licence Easy Facture</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <h6>Licence Lifetime - 199€</h6>
                <p class="text-muted">
                    Passez à la licence lifetime et profitez de toutes les fonctionnalités d'Easy Facture sans limitation de durée.
                </p>
                <ul class="mb-3">
                    <li>✅ Accès illimité à toutes les fonctionnalités</li>
                    <li>✅ Mises à jour gratuites à vie</li>
                    <li>✅ Support technique prioritaire</li>
                    <li>✅ Paiement unique, aucun abonnement</li>
                </ul>
            </div>
            <div class="col-md-4 text-center">
                <div class="p-3 bg-light rounded">
                    <h3 class="text-primary mb-0">199€</h3>
                    <small class="text-muted">Paiement unique</small>
                </div>
                <button type="button" class="btn btn-success btn-lg mt-3"
                        data-bs-toggle="modal" data-bs-target="#purchaseModal">
                    <i class="bi bi-cart-check"></i> Obtenir la licence
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'achat de licence -->
<div class="modal fade" id="purchaseModal" tabindex="-1" aria-labelledby="purchaseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="purchaseModalLabel">
                    <i class="bi bi-cart-check"></i> Obtenir une licence Lifetime
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Vous allez être redirigé vers notre page de paiement sécurisée (Stripe).
                </div>

                <form id="purchaseForm">
                    <div class="mb-3">
                        <label for="purchaseEmail" class="form-label">Votre adresse email *</label>
                        <input type="email"
                               class="form-control"
                               id="purchaseEmail"
                               required
                               placeholder="votre@email.com"
                               value="{{ entreprise.email or '' }}">
                        <small class="text-muted">
                            Votre licence sera envoyée à cette adresse après le paiement
                        </small>
                    </div>

                    <div class="alert alert-success">
                        <strong>Prix: 199€</strong> (paiement unique)
                        <br>
                        <small>Paiement sécurisé par Stripe - Carte bancaire acceptée</small>
                    </div>
                </form>

                <div id="purchaseError" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="confirmPurchaseBtn">
                    <i class="bi bi-lock"></i> Procéder au paiement
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('confirmPurchaseBtn').addEventListener('click', function() {
    const email = document.getElementById('purchaseEmail').value;
    const errorDiv = document.getElementById('purchaseError');
    const btn = this;

    // Validation email
    if (!email || !email.includes('@')) {
        errorDiv.textContent = 'Veuillez entrer une adresse email valide';
        errorDiv.classList.remove('d-none');
        return;
    }

    // Désactiver le bouton et afficher le chargement
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Redirection...';
    errorDiv.classList.add('d-none');

    // Appeler l'API pour initier l'achat
    fetch('/parametres/purchase-license', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.checkout_url) {
            // Rediriger vers Stripe Checkout
            window.location.href = data.checkout_url;
        } else {
            // Afficher l'erreur
            errorDiv.textContent = data.message || 'Erreur lors de la création de la session de paiement';
            errorDiv.classList.remove('d-none');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-lock"></i> Procéder au paiement';
        }
    })
    .catch(error => {
        errorDiv.textContent = 'Erreur réseau: ' + error.message;
        errorDiv.classList.remove('d-none');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-lock"></i> Procéder au paiement';
    });
});
</script>
{% endblock %}
